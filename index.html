<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Coding Contest Tracker</title>

    <!-- Manifest for PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e293b">

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            background-color: #0f172a;
            color: white;
        }
        .contest-card {
            transition: transform 0.2s, border-color 0.2s;
            border: 1px solid #1e293b;
        }
        .contest-card:hover {
            transform: translateY(-5px);
            border-color: #3b82f6;
        }
    </style>
</head>

<body class="p-4 md:p-8">
<div class="max-w-5xl mx-auto">

    <header class="mb-10 text-center">
        <h1 class="text-4xl font-bold text-blue-400 mb-2">
            Upcoming Coding Contests
        </h1>
        <p class="text-slate-400">
            Next 7 days Â· Famous platforms only
        </p>
        <div id="status" class="mt-4 text-sm text-slate-500 italic">
            Fetching contests...
        </div>
    </header>

    <div id="contest-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>

</div>

<script>
/* ================= PWA SERVICE WORKER ================= */
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js");
}

/* ================= CONFIG ================= */
const USERNAME = 'WhatADrag';
const API_KEY = 'c337ee2f074d30a050ba4bfab4e8664c6af388b0';

const API_URL =
`https://clist.by/api/v4/contest/?username=${USERNAME}&api_key=${API_KEY}&upcoming=true&order_by=start`;

const ALLOWED_PLATFORMS = [
    'codeforces','codechef','atcoder','leetcode',
    'hackerrank','hackerearth','topcoder','google','meta'
];

/* ================= DAILY COLORS ================= */
const DAILY_COLORS = [
    "#000000","#3B3131","#696969","#808080","#A9A9A9",
    "#FFD700","#FF8C00","#FF4500","#DC143C",
    "#8A2BE2","#6A5ACD","#4169E1","#1E90FF",
    "#00CED1","#20B2AA","#32CD32","#7FFF00",
    "#FFFF00","#F4A460","#8B4513"
];

function getDailyColor() {
    const today = new Date().toISOString().slice(0, 10);
    const saved = localStorage.getItem("dailyColor");

    if (saved) {
        const { date, color } = JSON.parse(saved);
        if (date === today) return color;
    }

    const color = DAILY_COLORS[Math.floor(Math.random() * DAILY_COLORS.length)];
    localStorage.setItem("dailyColor", JSON.stringify({ date: today, color }));
    return color;
}

const BUTTON_COLOR = getDailyColor();

/* ================= DATA FETCH ================= */
async function fetchContests() {
    try {
        const res = await fetch(API_URL);
        const data = await res.json();

        const now = new Date();
        const limit = new Date();
        limit.setDate(now.getDate() + 7);

        const contests = data.objects.filter(c => {
            const start = new Date(c.start);
            const platform = c.resource.toLowerCase();
            return start >= now &&
                   start <= limit &&
                   ALLOWED_PLATFORMS.some(p => platform.includes(p));
        });

        contests.sort((a, b) => new Date(a.start) - new Date(b.start));
        renderContests(contests);

        document.getElementById("status").innerText =
            `Showing ${contests.length} contests Â· Updated ${new Date().toLocaleTimeString()}`;
    } catch {
        document.getElementById("status").innerText = "Failed to load contests";
    }
}

function timeRemaining(start) {
    const diff = new Date(start) - new Date();
    if (diff <= 0) return "Starting now";
    const mins = Math.floor(diff / 60000);
    if (mins < 60) return `Starts in ${mins} minutes`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return `Starts in ${hrs} hours`;
    return `Starts in ${Math.floor(hrs / 24)} days`;
}

function renderContests(contests) {
    const container = document.getElementById("contest-list");
    container.innerHTML = "";

    if (!contests.length) {
        container.innerHTML =
            `<div class="col-span-full text-center text-slate-400">
                No contests in the next 7 days ðŸš€
            </div>`;
        return;
    }

    contests.forEach(c => {
        const card = document.createElement("div");
        card.className =
            "contest-card bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col justify-between";

        card.innerHTML = `
            <div>
                <div class="flex justify-between mb-4">
                    <span class="bg-blue-900 text-blue-200 text-xs font-bold px-2.5 py-0.5 rounded">
                        ${c.resource}
                    </span>
                    <span class="text-slate-400 text-xs">
                        ${Math.floor(c.duration / 3600)} hrs
                    </span>
                </div>

                <h2 class="text-xl font-semibold mb-1">${c.event}</h2>
                <p class="text-blue-400 text-sm mb-2">${timeRemaining(c.start)}</p>
                <p class="text-slate-400 text-sm">
                    Starts at: ${new Date(c.start).toLocaleString()}
                </p>
            </div>

            <a href="${c.href}" target="_blank"
               style="background:${BUTTON_COLOR};color:black"
               class="block mt-4 text-center font-bold py-2 px-4 rounded transition hover:scale-105 shadow-lg">
                Register / View
            </a>
        `;
        container.appendChild(card);
    });
}

fetchContests();
setInterval(fetchContests, 30 * 60 * 1000);
</script>
</body>
</html>
