<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Coding Contest Tracker</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1e293b">

<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
    background-color: #0f172a;
    color: white;
}
.contest-card {
    transition: transform 0.2s, border-color 0.2s;
    border: 1px solid #1e293b;
}
.contest-card:hover {
    transform: translateY(-5px);
    border-color: #3b82f6;
}
</style>
</head>

<body class="p-4 md:p-8">
<div class="max-w-5xl mx-auto">

<header class="mb-10 text-center">
    <h1 class="text-4xl font-bold text-blue-400 mb-2">
        Upcoming & Ongoing Coding Contests
    </h1>
    <p class="text-slate-400">
        Next 7 days Â· Local time Â· Famous platforms
    </p>
    <div id="status" class="mt-4 text-sm text-slate-500 italic">
        Fetching contests...
    </div>
</header>

<div id="contest-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>

</div>

<script>
/* ================= SERVICE WORKER ================= */
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js");
}

/* ================= CONFIG ================= */
const USERNAME = "WhatADrag";
const API_KEY = "c337ee2f074d30a050ba4bfab4e8664c6af388b0";

const API_URL =
`https://clist.by/api/v4/contest/?username=${USERNAME}&api_key=${API_KEY}&upcoming=true&order_by=start`;

const ALLOWED_PLATFORMS = [
    "codeforces","codechef","atcoder","leetcode",
    "hackerrank","hackerearth","topcoder","google","meta"
];

/* ================= DAILY COLORS (NO BLACK) ================= */
const DAILY_COLORS = [
    "#3B3131","#696969","#808080","#A9A9A9",
    "#FFD700","#FF8C00","#FF4500","#DC143C",
    "#8A2BE2","#6A5ACD","#4169E1","#1E90FF",
    "#00CED1","#20B2AA","#32CD32","#7FFF00",
    "#FFFF00","#F4A460","#8B4513"
];

function getDailyColor() {
    const today = new Date().toISOString().slice(0,10);
    const saved = localStorage.getItem("dailyColor");

    if (saved) {
        const { date, color } = JSON.parse(saved);
        if (date === today) return color;
    }

    const color = DAILY_COLORS[Math.floor(Math.random() * DAILY_COLORS.length)];
    localStorage.setItem("dailyColor", JSON.stringify({ date: today, color }));
    return color;
}

const BUTTON_COLOR = getDailyColor();

/* ================= TIME HELPERS ================= */
function utcToLocal(dateStr) {
    return new Date(dateStr + "Z"); // FORCE UTC
}

function formatLocalTime(date) {
    return date.toLocaleString(undefined, {
        weekday: "short",
        year: "numeric",
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        hour12: true,
        timeZoneName: "short"
    });
}

function contestStatus(start, end) {
    const now = new Date();
    if (now >= start && now <= end) return "ONGOING";
    if (now < start) {
        const mins = Math.floor((start - now) / 60000);
        if (mins < 60) return `Starts in ${mins} min`;
        const hrs = Math.floor(mins / 60);
        if (hrs < 24) return `Starts in ${hrs} hrs`;
        return `Starts in ${Math.floor(hrs / 24)} days`;
    }
    return "Finished";
}

/* ================= FETCH DATA ================= */
async function fetchContests() {
    try {
        const res = await fetch(API_URL);
        const data = await res.json();

        const now = new Date();
        const limit = new Date();
        limit.setDate(now.getDate() + 7);

        const contests = data.objects.filter(c => {
            const start = utcToLocal(c.start);
            const end = new Date(start.getTime() + c.duration * 1000);
            const platform = c.resource.toLowerCase();

            return end > now &&
                   start <= limit &&
                   ALLOWED_PLATFORMS.some(p => platform.includes(p));
        });

        contests.sort((a, b) =>
            utcToLocal(a.start) - utcToLocal(b.start)
        );

        renderContests(contests);
        document.getElementById("status").innerText =
            `Showing ${contests.length} contests Â· Local time`;
    } catch {
        document.getElementById("status").innerText =
            "Failed to load contests";
    }
}

/* ================= RENDER ================= */
function renderContests(contests) {
    const container = document.getElementById("contest-list");
    container.innerHTML = "";

    if (!contests.length) {
        container.innerHTML =
            `<div class="col-span-full text-center text-slate-400">
                No contests available ðŸš€
            </div>`;
        return;
    }

    contests.forEach(c => {
        const start = utcToLocal(c.start);
        const end = new Date(start.getTime() + c.duration * 1000);
        const status = contestStatus(start, end);

        const badgeColor =
            status === "ONGOING"
                ? "bg-green-600 text-white"
                : "bg-blue-900 text-blue-200";

        const card = document.createElement("div");
        card.className =
            "contest-card bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col justify-between";

        card.innerHTML = `
        <div>
            <div class="flex justify-between mb-4">
                <span class="${badgeColor} text-xs font-bold px-2.5 py-0.5 rounded">
                    ${status}
                </span>
                <span class="text-slate-400 text-xs">
                    ${Math.floor(c.duration / 3600)} hrs
                </span>
            </div>

            <h2 class="text-xl font-semibold mb-1">${c.event}</h2>
            <p class="text-slate-400 text-sm">
                Starts: ${formatLocalTime(start)}
            </p>
            <p class="text-slate-400 text-sm">
                Ends: ${formatLocalTime(end)}
            </p>
        </div>

        <a href="${c.href}" target="_blank"
           class="block mt-4 text-center font-bold py-2 px-4 rounded transition hover:scale-105 shadow-lg text-slate-900"
           style="background:${BUTTON_COLOR}">
            Register / View
        </a>
        `;
        container.appendChild(card);
    });
}

fetchContests();
setInterval(fetchContests, 30 * 60 * 1000);
</script>
</body>
</html>
